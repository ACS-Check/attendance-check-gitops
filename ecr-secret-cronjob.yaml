apiVersion: v1
kind: ServiceAccount
metadata:
  name: ecr-secret-updater
  namespace: cc-frontend
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ecr-secret-updater
  namespace: cc-backend
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ecr-secret-updater
  namespace: cc-frontend
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "delete", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ecr-secret-updater
  namespace: cc-backend
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "delete", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ecr-secret-updater
  namespace: cc-frontend
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: ecr-secret-updater
subjects:
- kind: ServiceAccount
  name: ecr-secret-updater
  namespace: cc-frontend
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ecr-secret-updater
  namespace: cc-backend
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: ecr-secret-updater
subjects:
- kind: ServiceAccount
  name: ecr-secret-updater
  namespace: cc-backend
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ecr-secret-updater-frontend
  namespace: cc-frontend
spec:
  schedule: "0 */12 * * *"  # 12시간마다 실행
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: ecr-secret-updater
          restartPolicy: OnFailure
          containers:
          - name: ecr-secret-updater
            image: amazon/aws-cli:latest
            command:
            - /bin/sh
            - -c
            - |
              #!/bin/sh
              set -e
              
              echo "Starting ECR secret update process for cc-frontend..."
              
              # AWS 자격증명 확인
              if [ -z "$AWS_ACCOUNT_ID" ] || [ -z "$AWS_REGION" ]; then
                echo "Error: AWS_ACCOUNT_ID or AWS_REGION not set"
                exit 1
              fi
              
              # ECR 로그인 토큰 가져오기
              echo "Getting ECR login token..."
              PASSWORD=$(aws ecr get-login-password --region ${AWS_REGION})
              
              # kubectl 설치
              echo "Installing kubectl..."
              curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
              chmod +x kubectl
              mv kubectl /usr/local/bin/
              
              # 기존 secret 삭제
              echo "Deleting old secret..."
              kubectl delete secret ecr-secret -n cc-frontend --ignore-not-found=true
              
              # 새 secret 생성
              echo "Creating new secret..."
              kubectl create secret docker-registry -n cc-frontend ecr-secret \
                --docker-server="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com" \
                --docker-username=AWS \
                --docker-password="${PASSWORD}"
              
              echo "ECR secret updated successfully for cc-frontend!"
            env:
            - name: AWS_ACCOUNT_ID
              valueFrom:
                configMapKeyRef:
                  name: ecr-config
                  key: AWS_ACCOUNT_ID
            - name: AWS_REGION
              valueFrom:
                configMapKeyRef:
                  name: ecr-config
                  key: AWS_REGION
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: access-key-id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: secret-access-key
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ecr-secret-updater-backend
  namespace: cc-backend
spec:
  schedule: "0 */12 * * *"  # 12시간마다 실행
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: ecr-secret-updater
          restartPolicy: OnFailure
          containers:
          - name: ecr-secret-updater
            image: amazon/aws-cli:latest
            command:
            - /bin/sh
            - -c
            - |
              #!/bin/sh
              set -e
              
              echo "Starting ECR secret update process for cc-backend..."
              
              # AWS 자격증명 확인
              if [ -z "$AWS_ACCOUNT_ID" ] || [ -z "$AWS_REGION" ]; then
                echo "Error: AWS_ACCOUNT_ID or AWS_REGION not set"
                exit 1
              fi
              
              # ECR 로그인 토큰 가져오기
              echo "Getting ECR login token..."
              PASSWORD=$(aws ecr get-login-password --region ${AWS_REGION})
              
              # kubectl 설치
              echo "Installing kubectl..."
              curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
              chmod +x kubectl
              mv kubectl /usr/local/bin/
              
              # 기존 secret 삭제
              echo "Deleting old secret..."
              kubectl delete secret ecr-secret -n cc-backend --ignore-not-found=true
              
              # 새 secret 생성
              echo "Creating new secret..."
              kubectl create secret docker-registry -n cc-backend ecr-secret \
                --docker-server="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com" \
                --docker-username=AWS \
                --docker-password="${PASSWORD}"
              
              echo "ECR secret updated successfully for cc-backend!"
            env:
            - name: AWS_ACCOUNT_ID
              valueFrom:
                configMapKeyRef:
                  name: ecr-config
                  key: AWS_ACCOUNT_ID
            - name: AWS_REGION
              valueFrom:
                configMapKeyRef:
                  name: ecr-config
                  key: AWS_REGION
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: access-key-id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: secret-access-key
